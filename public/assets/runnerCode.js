class TinyShadeRunner{h;g;d;c;u;p=new Map;l=new Map;t=new Map;s;a;constructor(e,t){this.h=e,this.g=t}async init(){const e=await navigator.gpu.requestAdapter();if(!e)throw new Error("");this.d=await e.requestDevice(),this.c=this.h.getContext("webgpu");const t=window.devicePixelRatio||1;if(this.h.width=window.innerWidth*t,this.h.height=window.innerHeight*t,this.g.audio){const{code:e,data:t,activator:i}=this.g.audio,s=new Function(`${e}; return GPUSynth;`)();this.a=new s(this.d,t,...i??[])}const i=navigator.gpu.getPreferredCanvasFormat();this.c.configure({device:this.d,format:i,usage:16}),this.s=this.d.createSampler({magFilter:"linear",minFilter:"linear"}),this.u=this.d.createBuffer({size:this.g.uniforms.byteSize,usage:72});for(const e of this.g.passes){const t=[this.g.canvasSize.width,this.g.canvasSize.height];if("compute"!==e.type||e.isMain){if(!e.isMain){const i=()=>this.d.createTexture({size:t,format:"bgra8unorm",usage:20});this.t.set(e.name,[i(),i()])}}else this.t.set(e.name,[this.d.createTexture({size:t,format:"rgba8unorm",usage:12})]);const s=[],n=/@binding\s*\(\s*(\d+)\s*\)\s+var\s*(?:<([^>]+)>)?\s*([\w\d_]+)/g;let a;const r="compute"===e.type?4:2;for(;null!==(a=n.exec(e.shader));){const e=parseInt(a[1]),t=a[2]||"",i=a[3];t.includes("uniform")?s.push({binding:e,visibility:r,buffer:{type:"uniform"}}):t.includes("storage")||"outTex"===i?s.push({binding:e,visibility:r,storageTexture:{format:"rgba8unorm",access:"write-only"}}):"samp"===i?s.push({binding:e,visibility:r,sampler:{type:"filtering"}}):s.push({binding:e,visibility:r,texture:{sampleType:"float"}})}const o=this.d.createBindGroupLayout({entries:s});this.l.set(e.name,o);const h=this.d.createShaderModule({code:e.shader}),u=this.d.createPipelineLayout({bindGroupLayouts:[o]});"compute"===e.type?this.p.set(e.name,this.d.createComputePipeline({layout:u,compute:{module:h,entryPoint:"main"}})):this.p.set(e.name,this.d.createRenderPipeline({layout:u,vertex:{module:h,entryPoint:"vs"},fragment:{module:h,entryPoint:"main",targets:[{format:e.isMain?i:"bgra8unorm"}]}}))}this.g.audio}createBindGroup(e,t){const i=this.l.get(e.name),s=1-t,n=new Map;n.set("u",{buffer:this.u}),n.set("samp",this.s);for(const i of this.g.passes){if(i.isMain)continue;const a=this.t.get(i.name);"compute"===i.type?(i.name===e.name&&n.set("outTex",a[0].createView()),n.set(i.name,a[0].createView())):i.name===e.name?(n.set(i.name,a[s].createView()),n.set(`prev_${i.name}`,a[s].createView())):n.set(i.name,a[t].createView())}const a=[],r=/@binding\s*\(\s*(\d+)\s*\)\s+var\s*(?:<([^>]+)>)?\s*([\w\d_]+)/g;let o;for(;null!==(o=r.exec(e.shader));){const e=parseInt(o[1]),t=n.get(o[3]);t&&a.push({binding:e,resource:t})}return this.d.createBindGroup({layout:i,entries:a})}run(){const e=this.a;let t=0;e&&e.play();const i=s=>{t++;const n=t%2,a=e&&e.isPlaying?e.getTime():s/1e3,r=new Float32Array([this.h.width,this.h.height,this.h.width/this.h.height,a]);this.d.queue.writeBuffer(this.u,0,r);const o=this.d.createCommandEncoder();for(const e of this.g.passes){const t=this.createBindGroup(e,n);if("compute"===e.type){const i=o.beginComputePass();i.setPipeline(this.p.get(e.name)),i.setBindGroup(0,t),i.dispatchWorkgroups(Math.ceil(this.h.width/16),Math.ceil(this.h.height/16)),i.end()}else{const i=e.isMain?this.c.getCurrentTexture().createView():this.t.get(e.name)[n].createView(),s=o.beginRenderPass({colorAttachments:[{view:i,loadOp:"clear",storeOp:"store",clearValue:[0,0,0,1]}]});s.setPipeline(this.p.get(e.name)),s.setBindGroup(0,t),s.draw(3),s.end()}}this.d.queue.submit([o.finish()]),requestAnimationFrame(i)};requestAnimationFrame(i)}}